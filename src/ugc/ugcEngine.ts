/**\n * UGC 시나리오 엔진\n * Sprint 10: 시나리오 생성, 저장, 관리\n */\n\nimport { v4 as uuidv4 } from 'uuid';\nimport { UGCScenario, UGCStage, UGCDialogue, ScenarioRules, DifficultyTag } from './types';\nimport { generateChecksum } from './validateScenario';\n\n/**\n * 새로운 시나리오 생성\n */\nexport function createNewScenario(\n  title: string,\n  summary: string,\n  authorName: string = '익명 정비사',\n  language: 'ko' | 'en' = 'ko',\n  difficultyTag: DifficultyTag = 'NORMAL'\n): UGCScenario {\n  const now = Date.now();\n  const scenario: Omit<UGCScenario, 'checksum'> = {\n    id: uuidv4(),\n    version: 1,\n    title,\n    summary,\n    authorName,\n    language,\n    createdAt: now,\n    updatedAt: now,\n    difficultyTag,\n    stages: [],\n    dialogues: [],\n    rules: {\n      maxOfflineMultiplierAllowed: false,\n      rewardMode: 'NONE',\n      dailyRewardCap: 0,\n    },\n  };\n\n  return {\n    ...scenario,\n    checksum: generateChecksum(scenario),\n  };\n}\n\n/**\n * 스테이지 추가\n */\nexport function addStage(\n  scenario: UGCScenario,\n  enemyPresetId: string,\n  hpMultiplier: number = 1.0,\n  rewardMultiplier: number = 0.0,\n  isBoss: boolean = false\n): UGCScenario {\n  const newStage: UGCStage = {\n    stageIndex: scenario.stages.length,\n    enemyPresetId,\n    hpMultiplier,\n    rewardMultiplier,\n    modifiers: [],\n    isBoss,\n  };\n\n  const updated = {\n    ...scenario,\n    stages: [...scenario.stages, newStage],\n    updatedAt: Date.now(),\n  };\n\n  return {\n    ...updated,\n    checksum: generateChecksum(updated),\n  };\n}\n\n/**\n * 스테이지 수정\n */\nexport function updateStage(\n  scenario: UGCScenario,\n  stageIndex: number,\n  updates: Partial<UGCStage>\n): UGCScenario {\n  const updated = {\n    ...scenario,\n    stages: scenario.stages.map((stage, index) =>\n      index === stageIndex ? { ...stage, ...updates } : stage\n    ),\n    updatedAt: Date.now(),\n  };\n\n  return {\n    ...updated,\n    checksum: generateChecksum(updated),\n  };\n}\n\n/**\n * 스테이지 삭제\n */\nexport function removeStage(scenario: UGCScenario, stageIndex: number): UGCScenario {\n  const updated = {\n    ...scenario,\n    stages: scenario.stages\n      .filter((_, index) => index !== stageIndex)\n      .map((stage, index) => ({ ...stage, stageIndex: index })),\n    updatedAt: Date.now(),\n  };\n\n  return {\n    ...updated,\n    checksum: generateChecksum(updated),\n  };\n}\n\n/**\n * 대사 추가\n */\nexport function addDialogue(\n  scenario: UGCScenario,\n  speaker: 'DOKKAEBI' | 'JANGSEUNG' | 'HAETAE' | 'ANONYMOUS' | 'PLAYER',\n  text: string,\n  triggerStageIndex?: number\n): UGCScenario {\n  const newDialogue: UGCDialogue = {\n    speaker,\n    text,\n    triggerStageIndex,\n  };\n\n  const updated = {\n    ...scenario,\n    dialogues: [...(scenario.dialogues || []), newDialogue],\n    updatedAt: Date.now(),\n  };\n\n  return {\n    ...updated,\n    checksum: generateChecksum(updated),\n  };\n}\n\n/**\n * 대사 삭제\n */\nexport function removeDialogue(scenario: UGCScenario, dialogueIndex: number): UGCScenario {\n  const updated = {\n    ...scenario,\n    dialogues: (scenario.dialogues || []).filter((_, index) => index !== dialogueIndex),\n    updatedAt: Date.now(),\n  };\n\n  return {\n    ...updated,\n    checksum: generateChecksum(updated),\n  };\n}\n\n/**\n * 시나리오 기본 정보 수정\n */\nexport function updateScenarioInfo(\n  scenario: UGCScenario,\n  updates: Partial<Pick<UGCScenario, 'title' | 'summary' | 'authorName' | 'difficultyTag'>>\n): UGCScenario {\n  const updated = {\n    ...scenario,\n    ...updates,\n    updatedAt: Date.now(),\n  };\n\n  return {\n    ...updated,\n    checksum: generateChecksum(updated),\n  };\n}\n\n/**\n * 보상 규칙 설정\n */\nexport function setRewardRules(\n  scenario: UGCScenario,\n  rules: Partial<ScenarioRules>\n): UGCScenario {\n  const updated = {\n    ...scenario,\n    rules: {\n      ...scenario.rules,\n      ...rules,\n      maxOfflineMultiplierAllowed: false, // 항상 false\n    },\n    updatedAt: Date.now(),\n  };\n\n  return {\n    ...updated,\n    checksum: generateChecksum(updated),\n  };\n}\n\n/**\n * 시나리오 복제\n */\nexport function duplicateScenario(scenario: UGCScenario): UGCScenario {\n  const now = Date.now();\n  const newScenario: Omit<UGCScenario, 'checksum'> = {\n    ...scenario,\n    id: uuidv4(),\n    createdAt: now,\n    updatedAt: now,\n    title: `${scenario.title} (복사본)`,\n  };\n\n  return {\n    ...newScenario,\n    checksum: generateChecksum(newScenario),\n  };\n}\n\n/**\n * 난이도 태그 계산 (자동)\n */\nexport function calculateDifficultyTag(scenario: UGCScenario): DifficultyTag {\n  const avgHpMultiplier = scenario.stages.reduce((sum, stage) => sum + stage.hpMultiplier, 0) / scenario.stages.length;\n  const modifierCount = scenario.stages.reduce((sum, stage) => sum + stage.modifiers.length, 0);\n\n  if (avgHpMultiplier > 3.5 || modifierCount > 6) {\n    return 'HARD';\n  } else if (avgHpMultiplier > 2.0 || modifierCount > 3) {\n    return 'NORMAL';\n  } else {\n    return 'EASY';\n  }\n}\n
