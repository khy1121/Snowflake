/**\n * UGC 검증 유닛 테스트\n * Sprint 10: 보상 파밍, 치트, 보안 검증\n */\n\nimport { validateScenario, validatePayloadSize, generateChecksum, verifyChecksum } from '../ugc/validateScenario';\nimport { createNewScenario, addStage, addDialogue, setRewardRules } from '../ugc/ugcEngine';\nimport { scenarioToShareCode, shareCodeToScenario } from '../ugc/exportImport';\n\ndescribe('UGC Validation', () => {\n  // 1. 기본 시나리오 생성 및 검증\n  test('should create and validate a basic scenario', () => {\n    const scenario = createNewScenario('테스트 의뢰', '간단한 테스트', '테스터');\n    const result = validateScenario(scenario);\n\n    expect(result.isValid).toBe(false); // 스테이지가 없어서 실패\n    expect(result.errors.some(e => e.includes('스테이지'))).toBe(true);\n  });\n\n  // 2. 스테이지 개수 검증\n  test('should validate stage count (3-8)', () => {\n    let scenario = createNewScenario('테스트 의뢰', '간단한 테스트');\n\n    // 스테이지 3개 추가\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n    scenario = addStage(scenario, 'goblin', 1.5, 0.0);\n    scenario = addStage(scenario, 'goblin', 2.0, 0.0);\n\n    let result = validateScenario(scenario);\n    expect(result.isValid).toBe(true);\n\n    // 스테이지 8개 추가 (총 11개)\n    for (let i = 0; i < 8; i++) {\n      scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n    }\n\n    result = validateScenario(scenario);\n    expect(result.isValid).toBe(false);\n    expect(result.errors.some(e => e.includes('3~8개'))).toBe(true);\n  });\n\n  // 3. HP 배수 범위 검증\n  test('should validate HP multiplier range (1.0-5.0)', () => {\n    let scenario = createNewScenario('테스트 의뢰', '간단한 테스트');\n    scenario = addStage(scenario, 'goblin', 0.5, 0.0); // 범위 외\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n\n    const result = validateScenario(scenario);\n    expect(result.isValid).toBe(false);\n    expect(result.errors.some(e => e.includes('HP 배수'))).toBe(true);\n  });\n\n  // 4. 보상 배수 범위 검증 (0.0-1.0 상한)\n  test('should validate reward multiplier range (0.0-1.0)', () => {\n    let scenario = createNewScenario('테스트 의뢰', '간단한 테스트');\n    scenario = addStage(scenario, 'goblin', 1.0, 1.5); // 범위 외\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n\n    const result = validateScenario(scenario);\n    expect(result.isValid).toBe(false);\n    expect(result.errors.some(e => e.includes('보상 배수'))).toBe(true);\n  });\n\n  // 5. Modifier 개수 검증 (최대 3개)\n  test('should validate modifier count (max 3)', () => {\n    let scenario = createNewScenario('테스트 의뢰', '간단한 테스트');\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n\n    // 스테이지 0에 4개의 modifier 추가 (범위 외)\n    scenario.stages[0].modifiers = [\n      'SHIELD_PHASE',\n      'RAGE_PHASE',\n      'FAST_ENEMY',\n      'SLOW_PLAYER', // 4번째\n    ];\n\n    const result = validateScenario(scenario);\n    expect(result.isValid).toBe(false);\n    expect(result.errors.some(e => e.includes('Modifier'))).toBe(true);\n  });\n\n  // 6. 보상 파밍 방지 (총 보상 배수 상한)\n  test('should prevent reward farming (total multiplier limit)', () => {\n    let scenario = createNewScenario('테스트 의뢰', '간단한 테스트');\n    scenario = addStage(scenario, 'goblin', 1.0, 1.0); // 1.0\n    scenario = addStage(scenario, 'goblin', 1.0, 1.0); // 1.0\n    scenario = addStage(scenario, 'goblin', 1.0, 1.0); // 1.0 (총 3.0, 상한 2.0 초과)\n\n    const result = validateScenario(scenario);\n    expect(result.isValid).toBe(false);\n    expect(result.errors.some(e => e.includes('총 보상'))).toBe(true);\n  });\n\n  // 7. 금칙어 필터\n  test('should filter banned words', () => {\n    let scenario = createNewScenario('욕설1 의뢰', '간단한 테스트'); // 금칙어 포함\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n\n    const result = validateScenario(scenario);\n    expect(result.isValid).toBe(false);\n    expect(result.errors.some(e => e.includes('부적절'))).toBe(true);\n  });\n\n  // 8. 페이로드 크기 검증\n  test('should validate payload size (100KB limit)', () => {\n    let scenario = createNewScenario('테스트 의뢰', '간단한 테스트');\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n\n    const json = JSON.stringify(scenario);\n    const isValid = validatePayloadSize(json, 100);\n    expect(isValid).toBe(true);\n  });\n\n  // 9. Checksum 생성 및 검증\n  test('should generate and verify checksum', () => {\n    let scenario = createNewScenario('테스트 의뢰', '간단한 테스트');\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n\n    const isValid = verifyChecksum(scenario);\n    expect(isValid).toBe(true);\n  });\n\n  // 10. Export/Import 무결성\n  test('should maintain integrity during export/import', () => {\n    let scenario = createNewScenario('테스트 의뢰', '간단한 테스트');\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n\n    const shareCode = scenarioToShareCode(scenario);\n    const imported = shareCodeToScenario(shareCode);\n\n    expect(imported.id).toBe(scenario.id);\n    expect(imported.title).toBe(scenario.title);\n    expect(imported.stages.length).toBe(scenario.stages.length);\n  });\n\n  // 11. 오프라인 보상 뻥튀김 방지\n  test('should prevent offline multiplier abuse', () => {\n    let scenario = createNewScenario('테스트 의뢰', '간단한 테스트');\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n\n    scenario = setRewardRules(scenario, {\n      maxOfflineMultiplierAllowed: true, // 시도\n    });\n\n    const result = validateScenario(scenario);\n    expect(result.isValid).toBe(false);\n    expect(result.errors.some(e => e.includes('오프라인'))).toBe(true);\n  });\n\n  // 12. 대사 길이 검증\n  test('should validate dialogue length', () => {\n    let scenario = createNewScenario('테스트 의뢰', '간단한 테스트');\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n    scenario = addStage(scenario, 'goblin', 1.0, 0.0);\n\n    // 200자 초과 대사 추가\n    const longText = 'a'.repeat(201);\n    scenario = addDialogue(scenario, 'DOKKAEBI', longText);\n\n    const result = validateScenario(scenario);\n    expect(result.isValid).toBe(false);\n    expect(result.errors.some(e => e.includes('대사'))).toBe(true);\n  });\n});\n
