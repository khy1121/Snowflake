/**\n * 오퍼 엔진\n * 오퍼 자격 확인, 노출, 구매 로직\n */\n\nimport { Offer } from '../../types';\n\n/**\n * 오퍼 자격 확인\n */\nexport function isOfferEligible(\n  offer: Offer,\n  stage: number,\n  daysActive: number,\n  inactiveDays: number,\n  purchaseHistory: Record<string, number>,\n  prestige: number,\n  lastShownAt: Record<string, number> = {}\n): boolean {\n  // 기본 자격 확인\n  if (offer.eligibility.minStage && stage < offer.eligibility.minStage) return false;\n  if (offer.eligibility.maxStage && stage > offer.eligibility.maxStage) return false;\n  if (offer.eligibility.minDaysActive && daysActive < offer.eligibility.minDaysActive) return false;\n  if (offer.eligibility.maxDaysActive && daysActive > offer.eligibility.maxDaysActive) return false;\n  if (offer.eligibility.minInactiveDays && inactiveDays < offer.eligibility.minInactiveDays) return false;\n  if (offer.eligibility.minPrestige && prestige < offer.eligibility.minPrestige) return false;\n\n  // 구매 횟수 확인\n  if (offer.eligibility.maxPurchases) {\n    const purchaseCount = purchaseHistory[offer.id] || 0;\n    if (purchaseCount >= offer.eligibility.maxPurchases) return false;\n  }\n\n  // 쿨다운 확인\n  if (offer.eligibility.cooldownDays) {\n    const lastShown = lastShownAt[offer.id] || 0;\n    const cooldownMs = offer.eligibility.cooldownDays * 86400000;\n    if (Date.now() - lastShown < cooldownMs) return false;\n  }\n\n  // 만료 확인\n  if (offer.expiresIn) {\n    const createdAt = lastShownAt[`${offer.id}_created`] || Date.now();\n    if (Date.now() - createdAt > offer.expiresIn) return false;\n  }\n\n  return true;\n}\n\n/**\n * 자격 있는 오퍼 목록 가져오기\n */\nexport function getEligibleOffers(\n  offers: Offer[],\n  stage: number,\n  daysActive: number,\n  inactiveDays: number,\n  purchaseHistory: Record<string, number>,\n  prestige: number,\n  lastShownAt?: Record<string, number>\n): Offer[] {\n  return offers.filter((offer) =>\n    isOfferEligible(offer, stage, daysActive, inactiveDays, purchaseHistory, prestige, lastShownAt)\n  );\n}\n\n/**\n * 추천 오퍼 가져오기 (우선순위 기반)\n */\nexport function getRecommendedOffers(\n  offers: Offer[],\n  stage: number,\n  daysActive: number,\n  inactiveDays: number,\n  purchaseHistory: Record<string, number>,\n  prestige: number,\n  lastShownAt?: Record<string, number>,\n  maxRecommendations: number = 3\n): Offer[] {\n  const eligible = getEligibleOffers(\n    offers,\n    stage,\n    daysActive,\n    inactiveDays,\n    purchaseHistory,\n    prestige,\n    lastShownAt\n  );\n\n  return eligible\n    .sort((a, b) => (a.displayPriority || 999) - (b.displayPriority || 999))\n    .slice(0, maxRecommendations);\n}\n\n/**\n * 오퍼 구매\n */\nexport function purchaseOffer(\n  offer: Offer,\n  cosmeticTokens: number,\n  realCurrency: number = 0\n): {\n  success: boolean;\n  remainingTokens?: number;\n  remainingCurrency?: number;\n  error?: string;\n  contents?: any[];\n} {\n  // Mock 구매 (실제 결제는 PurchaseProvider에서 처리)\n  if (offer.price > cosmeticTokens && realCurrency === 0) {\n    return { success: false, error: '토큰 부족' };\n  }\n\n  return {\n    success: true,\n    remainingTokens: cosmeticTokens - (offer.price || 0),\n    contents: offer.contents,\n  };\n}\n\n/**\n * 오퍼 구매 기록 업데이트\n */\nexport function recordOfferPurchase(\n  purchaseHistory: Record<string, number>,\n  offerId: string\n): Record<string, number> {\n  return {\n    ...purchaseHistory,\n    [offerId]: (purchaseHistory[offerId] || 0) + 1,\n  };\n}\n\n/**\n * 오퍼 노출 기록 업데이트\n */\nexport function recordOfferShown(\n  lastShownAt: Record<string, number>,\n  offerId: string\n): Record<string, number> {\n  return {\n    ...lastShownAt,\n    [offerId]: Date.now(),\n    [`${offerId}_created`]: lastShownAt[`${offerId}_created`] || Date.now(),\n  };\n}\n\n/**\n * 오퍼 가격 포맷팅 (지역화)\n */\nexport function formatOfferPrice(\n  offer: Offer,\n  currency: 'KRW' | 'USD' = 'KRW'\n): string {\n  if (currency === 'USD') {\n    return `$${(offer.priceUSD || 0).toFixed(2)}`;\n  }\n  return `₩${(offer.price || 0).toLocaleString('ko-KR')}`;\n}\n\n/**\n * 오퍼 내용 설명\n */\nexport function getOfferContentsDescription(contents: any[]): string[] {\n  return contents.map((item) => {\n    switch (item.type) {\n      case 'gold':\n        return `골드 ${item.amount.toLocaleString('ko-KR')}`;\n      case 'cosmeticToken':\n        return `코스튬 토큰 ${item.amount}`;\n      case 'fragment':\n        return `설화 파편 ${item.amount}`;\n      case 'passXp':\n        return `패스 경험치 ${item.amount}`;\n      case 'prestigePoints':\n        return `Prestige 포인트 ${item.amount}`;\n      case 'offlineBoost':\n        return `오프라인 보상 상한 +${item.bonusHours}시간 (${Math.floor(item.duration / 86400000)}일)`;\n      default:\n        return `${item.type} ${item.amount}`;\n    }\n  });\n}\n\n/**\n * 오퍼 데이터 유효성 검사\n */\nexport function validateOfferData(offers: Offer[]): { valid: boolean; errors: string[] } {\n  const errors: string[] = [];\n\n  for (const offer of offers) {\n    if (!offer.id) errors.push(`오퍼 ID 누락`);\n    if (!offer.name) errors.push(`오퍼 이름 누락: ${offer.id}`);\n    if (!offer.price && offer.price !== 0) errors.push(`오퍼 가격 누락: ${offer.id}`);\n    if (!Array.isArray(offer.contents) || offer.contents.length === 0) {\n      errors.push(`오퍼 내용 누락: ${offer.id}`);\n    }\n  }\n\n  return { valid: errors.length === 0, errors };\n}\n
