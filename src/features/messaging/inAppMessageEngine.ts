/**\n * 인앱 메시지 엔진\n * 배너, 모달, 우편함 메시지 관리\n */\n\nexport type MessageType = 'banner' | 'modal' | 'inbox';\n\nexport interface InAppMessage {\n  id: string;\n  type: MessageType;\n  title: string;\n  body: string;\n  startAt: number;\n  endAt: number;\n  priority: 'low' | 'medium' | 'high';\n  ctaLabel?: string;\n  ctaRoute?: string;\n  isDismissible: boolean;\n}\n\nexport interface MessageState {\n  messageId: string;\n  isRead: boolean;\n  isDismissed: boolean;\n  dismissedAt?: number;\n}\n\n/**\n * 활성 메시지 필터링\n */\nexport function getActiveMessages(\n  messages: InAppMessage[],\n  now: number = Date.now()\n): InAppMessage[] {\n  return messages.filter(\n    (msg) => msg.startAt <= now && now < msg.endAt\n  );\n}\n\n/**\n * 메시지 타입별 필터링\n */\nexport function getMessagesByType(\n  messages: InAppMessage[],\n  type: MessageType\n): InAppMessage[] {\n  return messages.filter((msg) => msg.type === type);\n}\n\n/**\n * 우선순위별 정렬\n */\nexport function sortByPriority(messages: InAppMessage[]): InAppMessage[] {\n  const priorityMap = { high: 3, medium: 2, low: 1 };\n  return [...messages].sort(\n    (a, b) => priorityMap[b.priority] - priorityMap[a.priority]\n  );\n}\n\n/**\n * 메시지 읽음 표시\n */\nexport function markMessageAsRead(\n  state: MessageState\n): MessageState {\n  return {\n    ...state,\n    isRead: true,\n  };\n}\n\n/**\n * 메시지 닫음 표시\n */\nexport function dismissMessage(\n  state: MessageState\n): MessageState {\n  return {\n    ...state,\n    isDismissed: true,\n    dismissedAt: Date.now(),\n  };\n}\n\n/**\n * 표시할 메시지 결정\n */\nexport function getMessagesToDisplay(\n  messages: InAppMessage[],\n  messageStates: Map<string, MessageState>,\n  now: number = Date.now()\n): InAppMessage[] {\n  const active = getActiveMessages(messages, now);\n  \n  return active.filter((msg) => {\n    const state = messageStates.get(msg.id);\n    \n    // 상태가 없으면 표시\n    if (!state) return true;\n    \n    // 닫혀 있으면 표시 안 함 (중요 공지 제외)\n    if (state.isDismissed && msg.priority !== 'high') return false;\n    \n    return true;\n  });\n}\n\n/**\n * 배너 메시지 조회\n */\nexport function getActiveBanners(\n  messages: InAppMessage[],\n  messageStates: Map<string, MessageState>,\n  now: number = Date.now()\n): InAppMessage[] {\n  const toDisplay = getMessagesToDisplay(messages, messageStates, now);\n  return getMessagesByType(toDisplay, 'banner')\n    .slice(0, 1); // 배너는 1개만\n}\n\n/**\n * 모달 메시지 조회\n */\nexport function getActiveModals(\n  messages: InAppMessage[],\n  messageStates: Map<string, MessageState>,\n  now: number = Date.now()\n): InAppMessage[] {\n  const toDisplay = getMessagesToDisplay(messages, messageStates, now);\n  const modals = getMessagesByType(toDisplay, 'modal');\n  return sortByPriority(modals).slice(0, 1); // 모달은 1개만\n}\n\n/**\n * 우편함 메시지 조회\n */\nexport function getInboxMessages(\n  messages: InAppMessage[],\n  messageStates: Map<string, MessageState>,\n  now: number = Date.now()\n): InAppMessage[] {\n  const toDisplay = getMessagesToDisplay(messages, messageStates, now);\n  return getMessagesByType(toDisplay, 'inbox');\n}\n\n/**\n * 메시지 상태 초기화\n */\nexport function initializeMessageState(messageId: string): MessageState {\n  return {\n    messageId,\n    isRead: false,\n    isDismissed: false,\n  };\n}\n\n/**\n * 메시지 상태 저장/로드\n */\nexport function serializeMessageStates(\n  states: Map<string, MessageState>\n): Record<string, MessageState> {\n  const obj: Record<string, MessageState> = {};\n  states.forEach((state, key) => {\n    obj[key] = state;\n  });\n  return obj;\n}\n\nexport function deserializeMessageStates(\n  obj: Record<string, MessageState>\n): Map<string, MessageState> {\n  const map = new Map<string, MessageState>();\n  Object.entries(obj).forEach(([key, state]) => {\n    map.set(key, state);\n  });\n  return map;\n}\n
