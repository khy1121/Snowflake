/**\n * 정비소 꾸미기 엔진\n * 데코 아이템 관리, 배치, 프리셋 저장\n */\n\nimport { DecorItem, DecorPlacement, DecorPreset } from '../../types';\n\n/**\n * 데코 아이템 해금 여부 확인\n */\nexport function isDecorUnlocked(\n  itemId: string,\n  unlockedDecors: string[],\n  stage: number,\n  achievements: Record<string, boolean>,\n  companions: string[],\n  prestige: number\n): boolean {\n  if (unlockedDecors.includes(itemId)) return true;\n\n  // 조건 검사\n  const condition = getUnlockCondition(itemId);\n  if (!condition) return false;\n\n  if (condition === 'start') return true;\n  if (condition.startsWith('stage_')) {\n    const requiredStage = parseInt(condition.split('_')[1]);\n    return stage >= requiredStage;\n  }\n  if (condition.startsWith('achievement_')) {\n    const achievementId = condition.split('_')[1];\n    return achievements[achievementId] === true;\n  }\n  if (condition.startsWith('companion_')) {\n    const companionId = condition.split('_')[1];\n    return companions.includes(companionId);\n  }\n  if (condition.startsWith('prestige_')) {\n    const requiredPrestige = parseInt(condition.split('_')[1]);\n    return prestige >= requiredPrestige;\n  }\n  if (condition.startsWith('event_')) {\n    // 이벤트 조건은 별도 처리\n    return false;\n  }\n\n  return false;\n}\n\n/**\n * 데코 아이템의 해금 조건 가져오기\n */\nexport function getUnlockCondition(itemId: string): string | null {\n  // 실제로는 decor.json에서 로드\n  const conditions: Record<string, string> = {\n    wallpaper_wood: 'start',\n    wallpaper_stone: 'stage_20',\n    floor_grass: 'start',\n    floor_tile: 'stage_30',\n    sign_workshop: 'stage_10',\n    lamp_warm: 'achievement_10',\n    lamp_cool: 'stage_50',\n    workbench_wood: 'stage_15',\n    workbench_metal: 'prestige_1',\n    mascot_goblin: 'companion_goblin',\n    mascot_spirit: 'stage_40',\n    plant_small: 'start',\n    plant_large: 'stage_25',\n    shelf_books: 'stage_20',\n    carpet_soft: 'stage_35',\n    painting_landscape: 'achievement_5',\n    fountain: 'stage_60',\n    clock_vintage: 'stage_45',\n    lantern_paper: 'event_lunar',\n    statue_gold: 'prestige_2',\n  };\n  return conditions[itemId] || null;\n}\n\n/**\n * 데코 아이템 구매\n */\nexport function purchaseDecor(\n  itemId: string,\n  cosmeticTokens: number,\n  itemPrice: number\n): { success: boolean; remainingTokens: number; error?: string } {\n  if (cosmeticTokens < itemPrice) {\n    return { success: false, remainingTokens: cosmeticTokens, error: '토큰 부족' };\n  }\n  return { success: true, remainingTokens: cosmeticTokens - itemPrice };\n}\n\n/**\n * 데코 배치 추가\n */\nexport function addDecorPlacement(\n  placements: DecorPlacement[],\n  itemId: string,\n  position: { x: number; y: number },\n  rotation: number = 0\n): { success: boolean; placements: DecorPlacement[]; error?: string } {\n  const maxCount = getMaxPlacementCount(itemId);\n  const currentCount = placements.filter((p) => p.itemId === itemId).length;\n\n  if (currentCount >= maxCount) {\n    return {\n      success: false,\n      placements,\n      error: `최대 ${maxCount}개까지만 배치 가능`,\n    };\n  }\n\n  const newPlacement: DecorPlacement = {\n    id: `${itemId}_${Date.now()}`,\n    itemId,\n    position,\n    rotation,\n    createdAt: Date.now(),\n  };\n\n  return { success: true, placements: [...placements, newPlacement] };\n}\n\n/**\n * 데코 배치 제거\n */\nexport function removeDecorPlacement(\n  placements: DecorPlacement[],\n  placementId: string\n): DecorPlacement[] {\n  return placements.filter((p) => p.id !== placementId);\n}\n\n/**\n * 데코 배치 업데이트\n */\nexport function updateDecorPlacement(\n  placements: DecorPlacement[],\n  placementId: string,\n  updates: Partial<DecorPlacement>\n): DecorPlacement[] {\n  return placements.map((p) => (p.id === placementId ? { ...p, ...updates } : p));\n}\n\n/**\n * 최대 배치 가능 수 가져오기\n */\nexport function getMaxPlacementCount(itemId: string): number {\n  const maxCounts: Record<string, number> = {\n    wallpaper_wood: 1,\n    wallpaper_stone: 1,\n    floor_grass: 1,\n    floor_tile: 1,\n    sign_workshop: 1,\n    lamp_warm: 3,\n    lamp_cool: 3,\n    workbench_wood: 2,\n    workbench_metal: 2,\n    mascot_goblin: 5,\n    mascot_spirit: 5,\n    plant_small: 10,\n    plant_large: 5,\n    shelf_books: 3,\n    carpet_soft: 2,\n    painting_landscape: 4,\n    fountain: 1,\n    clock_vintage: 2,\n    lantern_paper: 5,\n    statue_gold: 1,\n  };\n  return maxCounts[itemId] || 1;\n}\n\n/**\n * 프리셋 저장\n */\nexport function savePreset(\n  presets: DecorPreset[],\n  placements: DecorPlacement[],\n  presetIndex: number,\n  name: string\n): DecorPreset[] {\n  const newPreset: DecorPreset = {\n    id: `preset_${presetIndex}`,\n    name,\n    placements: JSON.parse(JSON.stringify(placements)),\n    savedAt: Date.now(),\n  };\n\n  const updated = [...presets];\n  updated[presetIndex] = newPreset;\n  return updated;\n}\n\n/**\n * 프리셋 로드\n */\nexport function loadPreset(presets: DecorPreset[], presetIndex: number): DecorPlacement[] {\n  const preset = presets[presetIndex];\n  if (!preset) return [];\n  return JSON.parse(JSON.stringify(preset.placements));\n}\n\n/**\n * 프리셋 삭제\n */\nexport function deletePreset(presets: DecorPreset[], presetIndex: number): DecorPreset[] {\n  const updated = [...presets];\n  updated[presetIndex] = undefined as any;\n  return updated.filter((p) => p !== undefined);\n}\n\n/**\n * 배치 유효성 검사\n */\nexport function validatePlacements(placements: DecorPlacement[]): boolean {\n  // 각 아이템의 최대 배치 수 확인\n  const itemCounts: Record<string, number> = {};\n  for (const placement of placements) {\n    itemCounts[placement.itemId] = (itemCounts[placement.itemId] || 0) + 1;\n    const maxCount = getMaxPlacementCount(placement.itemId);\n    if (itemCounts[placement.itemId] > maxCount) {\n      return false;\n    }\n  }\n  return true;\n}\n
