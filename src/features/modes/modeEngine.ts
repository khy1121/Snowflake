/**\n * 모드 엔진\n * 도깨비 야간정비(타임어택), 망각상회 침투(선택지) 모드\n */\n\nexport type ModeType = 'time_attack' | 'choice_based';\n\nexport interface ModeEntry {\n  modeId: string;\n  date: string; // YYYY-MM-DD\n  entriesUsed: number;\n}\n\nexport interface TimeAttackSession {\n  modeId: string;\n  startTime: number;\n  duration: number;\n  kills: number;\n  bossKills: number;\n  currentStage: number;\n  score: number;\n  isActive: boolean;\n}\n\nexport interface ChoiceSession {\n  modeId: string;\n  currentRound: number;\n  totalRounds: number;\n  selectedBuffs: string[];\n  isActive: boolean;\n}\n\n/**\n * 일일 입장 횟수 확인\n */\nexport function getEntriesUsedToday(\n  entries: ModeEntry[],\n  modeId: string,\n  today: string = new Date().toISOString().split('T')[0]\n): number {\n  const entry = entries.find((e) => e.modeId === modeId && e.date === today);\n  return entry?.entriesUsed || 0;\n}\n\n/**\n * 입장 가능 여부\n */\nexport function canEnterMode(\n  entries: ModeEntry[],\n  modeId: string,\n  maxDailyEntries: number,\n  today: string = new Date().toISOString().split('T')[0]\n): boolean {\n  const used = getEntriesUsedToday(entries, modeId, today);\n  return used < maxDailyEntries;\n}\n\n/**\n * 입장 기록 추가\n */\nexport function recordModeEntry(\n  entries: ModeEntry[],\n  modeId: string,\n  today: string = new Date().toISOString().split('T')[0]\n): ModeEntry[] {\n  const existingIndex = entries.findIndex(\n    (e) => e.modeId === modeId && e.date === today\n  );\n\n  if (existingIndex >= 0) {\n    const updated = [...entries];\n    updated[existingIndex] = {\n      ...updated[existingIndex],\n      entriesUsed: updated[existingIndex].entriesUsed + 1,\n    };\n    return updated;\n  }\n\n  return [\n    ...entries,\n    {\n      modeId,\n      date: today,\n      entriesUsed: 1,\n    },\n  ];\n}\n\n/**\n * 타임어택 점수 계산\n */\nexport function calculateTimeAttackScore(\n  kills: number,\n  bossKills: number,\n  currentStage: number,\n  basePerKill: number = 10,\n  bossMultiplier: number = 5,\n  stageBonus: number = 1\n): number {\n  const killScore = kills * basePerKill;\n  const bossScore = bossKills * basePerKill * bossMultiplier;\n  const stageScore = currentStage * stageBonus;\n  return killScore + bossScore + stageScore;\n}\n\n/**\n * 타임어택 세션 초기화\n */\nexport function initializeTimeAttackSession(\n  modeId: string,\n  duration: number,\n  currentStage: number\n): TimeAttackSession {\n  return {\n    modeId,\n    startTime: Date.now(),\n    duration,\n    kills: 0,\n    bossKills: 0,\n    currentStage,\n    score: 0,\n    isActive: true,\n  };\n}\n\n/**\n * 타임어택 세션 업데이트\n */\nexport function updateTimeAttackSession(\n  session: TimeAttackSession,\n  kills: number = 0,\n  bossKills: number = 0,\n  scoreFormula: any = {}\n): TimeAttackSession {\n  const newKills = session.kills + kills;\n  const newBossKills = session.bossKills + bossKills;\n  const newScore = calculateTimeAttackScore(\n    newKills,\n    newBossKills,\n    session.currentStage,\n    scoreFormula.basePerKill || 10,\n    scoreFormula.bossMultiplier || 5,\n    scoreFormula.stageBonus || 1\n  );\n\n  const elapsed = Date.now() - session.startTime;\n  const isActive = elapsed < session.duration;\n\n  return {\n    ...session,\n    kills: newKills,\n    bossKills: newBossKills,\n    score: newScore,\n    isActive,\n  };\n}\n\n/**\n * 타임어택 세션 종료\n */\nexport function finishTimeAttackSession(\n  session: TimeAttackSession\n): TimeAttackSession {\n  return {\n    ...session,\n    isActive: false,\n  };\n}\n\n/**\n * 선택지 세션 초기화\n */\nexport function initializeChoiceSession(\n  modeId: string,\n  totalRounds: number\n): ChoiceSession {\n  return {\n    modeId,\n    currentRound: 1,\n    totalRounds,\n    selectedBuffs: [],\n    isActive: true,\n  };\n}\n\n/**\n * 선택지 선택\n */\nexport function selectChoice(\n  session: ChoiceSession,\n  choiceId: string\n): ChoiceSession {\n  const newBuffs = [...session.selectedBuffs, choiceId];\n  const nextRound = session.currentRound + 1;\n  const isActive = nextRound <= session.totalRounds;\n\n  return {\n    ...session,\n    selectedBuffs: newBuffs,\n    currentRound: nextRound,\n    isActive,\n  };\n}\n\n/**\n * 선택지 세션 완료\n */\nexport function finishChoiceSession(\n  session: ChoiceSession\n): ChoiceSession {\n  return {\n    ...session,\n    isActive: false,\n  };\n}\n\n/**\n * 남은 시간 계산 (ms)\n */\nexport function getTimeRemaining(\n  session: TimeAttackSession\n): number {\n  const elapsed = Date.now() - session.startTime;\n  const remaining = session.duration - elapsed;\n  return Math.max(0, remaining);\n}\n\n/**\n * 진행도 계산 (0~1)\n */\nexport function getProgress(\n  session: ChoiceSession\n): number {\n  return session.currentRound / session.totalRounds;\n}\n
