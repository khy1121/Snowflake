/**\n * 랭킹 시스템 엔진\n * 주간 스테이지, 정비 포인트, 이벤트 랭킹\n */\n\nexport type LeaderboardType = 'weekly_stage' | 'weekly_points' | 'event';\n\nexport interface LeaderboardEntry {\n  rank: number;\n  userId: string;\n  displayName: string;\n  value: number; // stage, points, or event tokens\n  timestamp: number;\n}\n\nexport interface LeaderboardData {\n  type: LeaderboardType;\n  weekKey: string; // YYYY-WW format\n  entries: LeaderboardEntry[];\n  lastUpdatedAt: number;\n}\n\n/**\n * 주간 키 생성 (YYYY-WW)\n */\nexport function getWeekKey(date: Date = new Date()): string {\n  const year = date.getFullYear();\n  const week = getWeekNumber(date);\n  return `${year}-${String(week).padStart(2, '0')}`;\n}\n\n/**\n * 주차 번호 계산\n */\nfunction getWeekNumber(date: Date): number {\n  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));\n  const dayNum = d.getUTCDay() || 7;\n  d.setUTCDate(d.getUTCDate() + 4 - dayNum);\n  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));\n  return Math.ceil(((d.getTime() - yearStart.getTime()) / 86400000 + 1) / 7);\n}\n\n/**\n * 랭킹 항목 생성\n */\nexport function createLeaderboardEntry(\n  userId: string,\n  displayName: string,\n  value: number\n): Omit<LeaderboardEntry, 'rank'> {\n  return {\n    userId,\n    displayName,\n    value,\n    timestamp: Date.now(),\n  };\n}\n\n/**\n * 랭킹 업데이트 (중복 제거, 정렬)\n */\nexport function updateLeaderboard(\n  entries: Omit<LeaderboardEntry, 'rank'>[],\n  newEntry: Omit<LeaderboardEntry, 'rank'>\n): Omit<LeaderboardEntry, 'rank'>[] {\n  // 기존 사용자 항목 제거\n  const filtered = entries.filter((e) => e.userId !== newEntry.userId);\n  \n  // 새 항목 추가\n  const updated = [...filtered, newEntry];\n  \n  // 값 기준 내림차순 정렬\n  updated.sort((a, b) => b.value - a.value);\n  \n  // 상위 100개만 유지\n  return updated.slice(0, 100);\n}\n\n/**\n * 랭킹 데이터에 순위 추가\n */\nexport function addRanksToLeaderboard(\n  entries: Omit<LeaderboardEntry, 'rank'>[]\n): LeaderboardEntry[] {\n  return entries.map((entry, index) => ({\n    ...entry,\n    rank: index + 1,\n  }));\n}\n\n/**\n * 사용자 순위 조회\n */\nexport function getUserRank(\n  entries: LeaderboardEntry[],\n  userId: string\n): LeaderboardEntry | null {\n  return entries.find((e) => e.userId === userId) || null;\n}\n\n/**\n * 상위 10% 보상 기준\n */\nexport function isTopPercentile(\n  rank: number,\n  totalEntries: number,\n  percentile: number = 10\n): boolean {\n  const threshold = Math.ceil((totalEntries * percentile) / 100);\n  return rank <= threshold;\n}\n\n/**\n * 랭킹 보상 계산\n */\nexport function calculateLeaderboardReward(\n  rank: number,\n  totalEntries: number\n): { cosmeticTokens: number; title?: string } {\n  if (rank <= 10) {\n    return { cosmeticTokens: 500, title: '최고의 정비사' };\n  }\n  if (rank <= 50) {\n    return { cosmeticTokens: 300, title: '뛰어난 정비사' };\n  }\n  if (isTopPercentile(rank, totalEntries, 10)) {\n    return { cosmeticTokens: 100 };\n  }\n  return { cosmeticTokens: 0 };\n}\n\n/**\n * 랭킹 데이터 초기화\n */\nexport function initializeLeaderboard(\n  type: LeaderboardType\n): LeaderboardData {\n  return {\n    type,\n    weekKey: getWeekKey(),\n    entries: [],\n    lastUpdatedAt: Date.now(),\n  };\n}\n\n/**\n * 주간 키 변경 확인\n */\nexport function shouldResetLeaderboard(lastWeekKey: string): boolean {\n  return lastWeekKey !== getWeekKey();\n}\n
