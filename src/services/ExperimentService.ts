/**\n * A/B 실험 서비스\n * Sticky assignment + 원격 설정 기반\n */\n\nexport interface ExperimentConfig {\n  key: string;\n  name: string;\n  description: string;\n  variants: Record<string, { label: string; rollout: number }>;\n  isActive: boolean;\n  startAt: number;\n  endAt: number;\n}\n\nexport interface ExperimentAssignment {\n  experimentKey: string;\n  variant: string;\n  assignedAt: number;\n}\n\n/**\n * 실험 variant 결정 (Sticky assignment)\n */\nexport function assignVariant(\n  experimentKey: string,\n  userId: string,\n  variants: Record<string, { label: string; rollout: number }>,\n  existingAssignment?: ExperimentAssignment\n): string {\n  // 기존 배정이 있으면 유지\n  if (existingAssignment && existingAssignment.experimentKey === experimentKey) {\n    return existingAssignment.variant;\n  }\n\n  // 사용자 ID와 실험 키로 해시 생성\n  const hash = simpleHash(`${userId}_${experimentKey}`);\n  const random = hash % 100;\n\n  let cumulative = 0;\n  for (const [variant, config] of Object.entries(variants)) {\n    cumulative += config.rollout;\n    if (random < cumulative) {\n      return variant;\n    }\n  }\n\n  // 폴백\n  return Object.keys(variants)[0];\n}\n\n/**\n * 간단한 해시 함수\n */\nfunction simpleHash(str: string): number {\n  let hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i);\n    hash = (hash << 5) - hash + char;\n    hash = hash & hash; // 32비트 정수로 변환\n  }\n  return Math.abs(hash);\n}\n\n/**\n * 실험 활성 여부 확인\n */\nexport function isExperimentActive(\n  config: ExperimentConfig,\n  now: number = Date.now()\n): boolean {\n  return config.isActive && config.startAt <= now && now < config.endAt;\n}\n\n/**\n * 배정된 variant 조회\n */\nexport function getAssignedVariant(\n  assignments: ExperimentAssignment[],\n  experimentKey: string\n): string | null {\n  const assignment = assignments.find((a) => a.experimentKey === experimentKey);\n  return assignment?.variant || null;\n}\n\n/**\n * 배정 저장\n */\nexport function saveAssignment(\n  assignments: ExperimentAssignment[],\n  experimentKey: string,\n  variant: string\n): ExperimentAssignment[] {\n  // 기존 배정 제거\n  const filtered = assignments.filter((a) => a.experimentKey !== experimentKey);\n  \n  // 새 배정 추가\n  return [\n    ...filtered,\n    {\n      experimentKey,\n      variant,\n      assignedAt: Date.now(),\n    },\n  ];\n}\n\n/**\n * 실험 노출 이벤트 로깅 정보\n */\nexport function createExperimentExposureEvent(\n  experimentKey: string,\n  variant: string\n): Record<string, any> {\n  return {\n    event_type: 'experiment_exposure',\n    experiment_key: experimentKey,\n    variant,\n    timestamp: Date.now(),\n  };\n}\n\n/**\n * 실험 결과 이벤트 로깅 정보\n */\nexport function createExperimentResultEvent(\n  experimentKey: string,\n  variant: string,\n  metric: string,\n  value: number\n): Record<string, any> {\n  return {\n    event_type: 'experiment_result',\n    experiment_key: experimentKey,\n    variant,\n    metric,\n    value,\n    timestamp: Date.now(),\n  };\n}\n\n/**\n * 모든 이벤트에 실험 정보 추가\n */\nexport function enrichEventWithExperiments(\n  event: Record<string, any>,\n  assignments: ExperimentAssignment[]\n): Record<string, any> {\n  const experiments: Record<string, string> = {};\n  assignments.forEach((assignment) => {\n    experiments[assignment.experimentKey] = assignment.variant;\n  });\n\n  return {\n    ...event,\n    experiments,\n  };\n}\n\n/**\n * 실험 설정 검증\n */\nexport function validateExperimentConfig(config: ExperimentConfig): boolean {\n  // 최소 2개 variant\n  if (Object.keys(config.variants).length < 2) {\n    return false;\n  }\n\n  // rollout 합계 = 100\n  const totalRollout = Object.values(config.variants).reduce(\n    (sum, v) => sum + v.rollout,\n    0\n  );\n  if (totalRollout !== 100) {\n    return false;\n  }\n\n  // 시간 유효성\n  if (config.startAt >= config.endAt) {\n    return false;\n  }\n\n  return true;\n}\n
