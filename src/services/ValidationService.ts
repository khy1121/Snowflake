/**\n * 치트 방지 및 검증 서비스\n * Soft clamp, 비정상 값 탐지, 로그\n */\n\nexport interface ValidationResult {\n  isValid: boolean;\n  reason?: string;\n  adjustedValue?: number;\n}\n\n/**\n * 스테이지 급상승 탐지\n */\nexport function validateStageJump(\n  previousStage: number,\n  newStage: number,\n  maxJump: number = 10\n): ValidationResult {\n  const jump = newStage - previousStage;\n\n  if (jump > maxJump) {\n    console.warn(\n      `[Validation] Suspicious stage jump: ${previousStage} → ${newStage} (jump: ${jump})`\n    );\n    return {\n      isValid: false,\n      reason: 'stage_jump_too_large',\n      adjustedValue: previousStage + maxJump,\n    };\n  }\n\n  return { isValid: true };\n}\n\n/**\n * 골드 급증 탐지\n */\nexport function validateGoldIncome(\n  previousGold: number,\n  newGold: number,\n  expectedIncome: number,\n  maxMultiplier: number = 5\n): ValidationResult {\n  const actualIncome = newGold - previousGold;\n  const multiplier = actualIncome / Math.max(expectedIncome, 1);\n\n  if (multiplier > maxMultiplier) {\n    console.warn(\n      `[Validation] Suspicious gold income: expected ${expectedIncome}, got ${actualIncome} (multiplier: ${multiplier}x)`\n    );\n    return {\n      isValid: false,\n      reason: 'gold_income_too_high',\n      adjustedValue: previousGold + expectedIncome * maxMultiplier,\n    };\n  }\n\n  return { isValid: true };\n}\n\n/**\n * 업그레이드 레벨 검증\n */\nexport function validateUpgradeLevel(\n  upgradeType: string,\n  level: number,\n  maxLevel: number = 1000\n): ValidationResult {\n  if (level < 0) {\n    return {\n      isValid: false,\n      reason: 'upgrade_level_negative',\n      adjustedValue: 0,\n    };\n  }\n\n  if (level > maxLevel) {\n    console.warn(\n      `[Validation] Upgrade level too high: ${upgradeType} level ${level} (max: ${maxLevel})`\n    );\n    return {\n      isValid: false,\n      reason: 'upgrade_level_too_high',\n      adjustedValue: maxLevel,\n    };\n  }\n\n  return { isValid: true };\n}\n\n/**\n * 타임스탬프 검증\n */\nexport function validateTimestamp(\n  timestamp: number,\n  maxDeviation: number = 60000 // 1분\n): ValidationResult {\n  const now = Date.now();\n  const deviation = Math.abs(now - timestamp);\n\n  if (deviation > maxDeviation) {\n    console.warn(\n      `[Validation] Suspicious timestamp: ${deviation}ms deviation from now`\n    );\n    return {\n      isValid: false,\n      reason: 'timestamp_deviation_too_large',\n      adjustedValue: now,\n    };\n  }\n\n  return { isValid: true };\n}\n\n/**\n * 오프라인 보상 검증\n */\nexport function validateOfflineReward(\n  offlineTime: number,\n  maxOfflineTime: number,\n  expectedReward: number,\n  actualReward: number\n): ValidationResult {\n  if (offlineTime > maxOfflineTime) {\n    console.warn(\n      `[Validation] Offline time exceeds cap: ${offlineTime}ms (max: ${maxOfflineTime}ms)`\n    );\n    return {\n      isValid: false,\n      reason: 'offline_time_exceeds_cap',\n      adjustedValue: Math.floor((expectedReward * maxOfflineTime) / offlineTime),\n    };\n  }\n\n  const multiplier = actualReward / Math.max(expectedReward, 1);\n  if (multiplier > 2) {\n    console.warn(\n      `[Validation] Offline reward multiplier too high: ${multiplier}x`\n    );\n    return {\n      isValid: false,\n      reason: 'offline_reward_multiplier_too_high',\n      adjustedValue: expectedReward * 2,\n    };\n  }\n\n  return { isValid: true };\n}\n\n/**\n * 랭킹 제출 검증\n */\nexport function validateLeaderboardSubmission(\n  stage: number,\n  points: number,\n  power: number,\n  lastSubmissionTime: number,\n  minSubmissionInterval: number = 60000 // 1분\n): ValidationResult {\n  // 제출 간격 확인\n  const timeSinceLastSubmission = Date.now() - lastSubmissionTime;\n  if (timeSinceLastSubmission < minSubmissionInterval) {\n    return {\n      isValid: false,\n      reason: 'submission_too_frequent',\n    };\n  }\n\n  // 값 범위 확인\n  if (stage < 1 || stage > 150) {\n    return {\n      isValid: false,\n      reason: 'stage_out_of_range',\n    };\n  }\n\n  if (points < 0 || points > 1000000) {\n    return {\n      isValid: false,\n      reason: 'points_out_of_range',\n    };\n  }\n\n  if (power < 0 || power > 100000) {\n    return {\n      isValid: false,\n      reason: 'power_out_of_range',\n    };\n  }\n\n  return { isValid: true };\n}\n\n/**\n * Soft clamp: 값을 범위 내로 조정\n */\nexport function softClamp(\n  value: number,\n  min: number,\n  max: number\n): number {\n  if (value < min) return min;\n  if (value > max) return max;\n  return value;\n}\n\n/**\n * 비정상 값 로깅\n */\nexport function logAnomalyDetected(\n  userId: string,\n  anomalyType: string,\n  details: Record<string, any>\n): void {\n  console.warn(\n    `[Anomaly] User: ${userId}, Type: ${anomalyType}`,\n    details\n  );\n  // 실제로는 분석 서버로 전송\n}\n
