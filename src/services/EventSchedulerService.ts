/**\n * 이벤트 스케줄러 서비스\n * 주간 로테이션, 시즌 관리\n */\n\nexport interface ScheduledEvent {\n  id: string;\n  name: string;\n  type: 'event' | 'mode_bonus' | 'banner';\n  startAt: number;\n  endAt: number;\n  rotation?: 'weekly' | 'monthly' | 'seasonal';\n  rotationStartDay?: number; // 0=Sunday, 1=Monday, ...\n  rotationStartHour?: number; // 0-23 (UTC)\n  data?: Record<string, any>;\n}\n\nexport interface ActiveEvent {\n  id: string;\n  name: string;\n  type: string;\n  startsIn?: number; // ms\n  endsIn?: number; // ms\n  isActive: boolean;\n}\n\n/**\n * 현재 주차 시작 시간 계산\n */\nexport function getWeekStartTime(\n  date: Date = new Date(),\n  startDay: number = 1, // Monday\n  startHour: number = 0 // UTC\n): Date {\n  const d = new Date(date);\n  const dayOfWeek = d.getUTCDay();\n  const diff = (dayOfWeek - startDay + 7) % 7;\n\n  d.setUTCDate(d.getUTCDate() - diff);\n  d.setUTCHours(startHour, 0, 0, 0);\n\n  return d;\n}\n\n/**\n * 현재 주차 종료 시간 계산\n */\nexport function getWeekEndTime(\n  date: Date = new Date(),\n  startDay: number = 1,\n  startHour: number = 0\n): Date {\n  const weekStart = getWeekStartTime(date, startDay, startHour);\n  const weekEnd = new Date(weekStart);\n  weekEnd.setUTCDate(weekEnd.getUTCDate() + 7);\n  return weekEnd;\n}\n\n/**\n * 이벤트 활성 여부 확인\n */\nexport function isEventActive(\n  event: ScheduledEvent,\n  now: number = Date.now()\n): boolean {\n  return event.startAt <= now && now < event.endAt;\n}\n\n/**\n * 회전 이벤트의 현재 인스턴스 기간 계산\n */\nexport function getRotationInstanceTiming(\n  event: ScheduledEvent,\n  now: number = Date.now()\n): { startAt: number; endAt: number } {\n  if (event.rotation === 'weekly') {\n    const weekStart = getWeekStartTime(\n      new Date(now),\n      event.rotationStartDay || 1,\n      event.rotationStartHour || 0\n    );\n    const weekEnd = getWeekEndTime(\n      new Date(now),\n      event.rotationStartDay || 1,\n      event.rotationStartHour || 0\n    );\n    return {\n      startAt: weekStart.getTime(),\n      endAt: weekEnd.getTime(),\n    };\n  }\n\n  // 고정 기간 이벤트\n  return {\n    startAt: event.startAt,\n    endAt: event.endAt,\n  };\n}\n\n/**\n * 활성 이벤트 목록 계산\n */\nexport function getActiveEvents(\n  events: ScheduledEvent[],\n  now: number = Date.now()\n): ActiveEvent[] {\n  return events\n    .map((event) => {\n      const timing = getRotationInstanceTiming(event, now);\n      const isActive = timing.startAt <= now && now < timing.endAt;\n      const startsIn = timing.startAt - now;\n      const endsIn = timing.endAt - now;\n\n      return {\n        id: event.id,\n        name: event.name,\n        type: event.type,\n        startsIn: startsIn > 0 ? startsIn : undefined,\n        endsIn: endsIn > 0 ? endsIn : undefined,\n        isActive,\n      };\n    })\n    .filter((e) => e.isActive || (e.startsIn && e.startsIn < 86400000)); // 24시간 이내\n}\n\n/**\n * 다음 이벤트 계산\n */\nexport function getNextEvent(\n  events: ScheduledEvent[],\n  now: number = Date.now()\n): ScheduledEvent | null {\n  const upcoming = events\n    .map((event) => {\n      const timing = getRotationInstanceTiming(event, now);\n      return {\n        event,\n        startsIn: timing.startAt - now,\n      };\n    })\n    .filter((e) => e.startsIn > 0)\n    .sort((a, b) => a.startsIn - b.startsIn);\n\n  return upcoming.length > 0 ? upcoming[0].event : null;\n}\n\n/**\n * 이벤트 템플릿 생성\n */\nexport function createWeeklyEventTemplate(\n  id: string,\n  name: string,\n  type: string,\n  startDay: number = 1,\n  startHour: number = 0\n): ScheduledEvent {\n  const now = Date.now();\n  const weekStart = getWeekStartTime(new Date(now), startDay, startHour);\n  const weekEnd = getWeekEndTime(new Date(now), startDay, startHour);\n\n  return {\n    id,\n    name,\n    type,\n    startAt: weekStart.getTime(),\n    endAt: weekEnd.getTime(),\n    rotation: 'weekly',\n    rotationStartDay: startDay,\n    rotationStartHour: startHour,\n  };\n}\n\n/**\n * 시간 포맷팅 (남은 시간)\n */\nexport function formatTimeRemaining(ms: number): string {\n  const seconds = Math.floor(ms / 1000);\n  const minutes = Math.floor(seconds / 60);\n  const hours = Math.floor(minutes / 60);\n  const days = Math.floor(hours / 24);\n\n  if (days > 0) return `${days}일 ${hours % 24}시간`;\n  if (hours > 0) return `${hours}시간 ${minutes % 60}분`;\n  if (minutes > 0) return `${minutes}분 ${seconds % 60}초`;\n  return `${seconds}초`;\n}\n
