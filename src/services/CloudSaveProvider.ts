/**\n * 클라우드 세이브(Cloud Save) 제공자\n * 기기 변경 시 게임 진행도 복원\n */\n\nimport { SaveState } from '@/types';\n\nexport interface CloudSaveMetadata {\n  version: number;\n  timestamp: number;\n  stage: number;\n  gold: number;\n  fragments: number;\n  companionCount: number;\n}\n\nexport interface ICloudSaveProvider {\n  backup(saveState: SaveState): Promise<{ success: boolean; backupId?: string }>;\n  restore(): Promise<{ success: boolean; saveState?: SaveState; metadata?: CloudSaveMetadata }>;\n  getBackupMetadata(): Promise<CloudSaveMetadata | null>;\n  deleteBackup(): Promise<boolean>;\n}\n\n/**\n * 백업 코드 기반 클라우드 세이브 (서버 없음)\n */\nexport class BackupCodeCloudSaveProvider implements ICloudSaveProvider {\n  /**\n   * SaveState를 Base64 인코딩하여 백업 코드 생성\n   */\n  private encodeToBackupCode(saveState: SaveState): string {\n    const json = JSON.stringify(saveState);\n    return Buffer.from(json).toString('base64');\n  }\n\n  /**\n   * 백업 코드를 디코딩하여 SaveState 복원\n   */\n  private decodeFromBackupCode(backupCode: string): SaveState | null {\n    try {\n      const json = Buffer.from(backupCode, 'base64').toString('utf-8');\n      return JSON.parse(json) as SaveState;\n    } catch (error) {\n      console.error('Failed to decode backup code:', error);\n      return null;\n    }\n  }\n\n  async backup(\n    saveState: SaveState\n  ): Promise<{ success: boolean; backupId?: string }> {\n    try {\n      const backupCode = this.encodeToBackupCode(saveState);\n      // 실제로는 클립보드에 복사하거나 파일로 저장\n      console.log('[CloudSave] Backup code:', backupCode);\n      return {\n        success: true,\n        backupId: backupCode,\n      };\n    } catch (error) {\n      console.error('Backup failed:', error);\n      return { success: false };\n    }\n  }\n\n  async restore(): Promise<{\n    success: boolean;\n    saveState?: SaveState;\n    metadata?: CloudSaveMetadata;\n  }> {\n    // 클립보드에서 백업 코드 읽기 (실제 구현)\n    // const backupCode = await Clipboard.getString();\n    // const saveState = this.decodeFromBackupCode(backupCode);\n    return { success: false };\n  }\n\n  async getBackupMetadata(): Promise<CloudSaveMetadata | null> {\n    return null;\n  }\n\n  async deleteBackup(): Promise<boolean> {\n    return true;\n  }\n}\n\n/**\n * Firebase 기반 클라우드 세이브\n * 주석: 실제 구현 시 다음과 같이 구현할 수 있습니다.\n *\n * import { getAuth, signInAnonymously } from 'firebase/auth';\n * import { getFirestore, doc, setDoc, getDoc, deleteDoc } from 'firebase/firestore';\n *\n * export class FirebaseCloudSaveProvider implements ICloudSaveProvider {\n *   private auth: any;\n *   private firestore: any;\n *   private userId: string | null = null;\n *\n *   constructor(firebaseApp: any) {\n *     this.auth = getAuth(firebaseApp);\n *     this.firestore = getFirestore(firebaseApp);\n *   }\n *\n *   private async ensureAuth(): Promise<string> {\n *     if (!this.userId) {\n *       const userCredential = await signInAnonymously(this.auth);\n *       this.userId = userCredential.user.uid;\n *     }\n *     return this.userId;\n *   }\n *\n *   async backup(\n *     saveState: SaveState\n *   ): Promise<{ success: boolean; backupId?: string }> {\n *     try {\n *       const userId = await this.ensureAuth();\n *       const docRef = doc(this.firestore, 'saves', userId);\n *\n *       await setDoc(docRef, {\n *         data: saveState,\n *         timestamp: Date.now(),\n *       });\n *\n *       return {\n *         success: true,\n *         backupId: userId,\n *       };\n *     } catch (error) {\n *       console.error('Backup failed:', error);\n *       return { success: false };\n *     }\n *   }\n *\n *   async restore(): Promise<{\n *     success: boolean;\n *     saveState?: SaveState;\n *     metadata?: CloudSaveMetadata;\n *   }> {\n *     try {\n *       const userId = await this.ensureAuth();\n *       const docRef = doc(this.firestore, 'saves', userId);\n *       const docSnap = await getDoc(docRef);\n *\n *       if (docSnap.exists()) {\n *         const saveState = docSnap.data().data as SaveState;\n *         const metadata: CloudSaveMetadata = {\n *           version: saveState.version,\n *           timestamp: docSnap.data().timestamp,\n *           stage: saveState.currentStage,\n *           gold: saveState.gold,\n *           fragments: saveState.fragments,\n *           companionCount: Object.keys(saveState.companionProgress).length,\n *         };\n *\n *         return {\n *           success: true,\n *           saveState,\n *           metadata,\n *         };\n *       }\n *\n *       return { success: false };\n *     } catch (error) {\n *       console.error('Restore failed:', error);\n *       return { success: false };\n *     }\n *   }\n *\n *   async getBackupMetadata(): Promise<CloudSaveMetadata | null> {\n *     try {\n *       const userId = await this.ensureAuth();\n *       const docRef = doc(this.firestore, 'saves', userId);\n *       const docSnap = await getDoc(docRef);\n *\n *       if (docSnap.exists()) {\n *         const saveState = docSnap.data().data as SaveState;\n *         return {\n *           version: saveState.version,\n *           timestamp: docSnap.data().timestamp,\n *           stage: saveState.currentStage,\n *           gold: saveState.gold,\n *           fragments: saveState.fragments,\n *           companionCount: Object.keys(saveState.companionProgress).length,\n *         };\n *       }\n *\n *       return null;\n *     } catch (error) {\n *       console.error('Get metadata failed:', error);\n *       return null;\n *     }\n *   }\n *\n *   async deleteBackup(): Promise<boolean> {\n *     try {\n *       const userId = await this.ensureAuth();\n *       const docRef = doc(this.firestore, 'saves', userId);\n *       await deleteDoc(docRef);\n *       return true;\n *     } catch (error) {\n *       console.error('Delete backup failed:', error);\n *       return false;\n *     }\n *   }\n * }\n */\n\n/**\n * 싱글톤 인스턴스\n */\nlet cloudSaveProvider: ICloudSaveProvider = new BackupCodeCloudSaveProvider();\n\n/**\n * 클라우드 세이브 제공자 설정\n */\nexport function setCloudSaveProvider(provider: ICloudSaveProvider): void {\n  cloudSaveProvider = provider;\n}\n\n/**\n * 클라우드 세이브 제공자 조회\n */\nexport function getCloudSaveProvider(): ICloudSaveProvider {\n  return cloudSaveProvider;\n}\n\n/**\n * 편의 함수\n */\nexport async function backupToCloud(\n  saveState: SaveState\n): Promise<{ success: boolean; backupId?: string }> {\n  return cloudSaveProvider.backup(saveState);\n}\n\nexport async function restoreFromCloud(): Promise<{\n  success: boolean;\n  saveState?: SaveState;\n  metadata?: CloudSaveMetadata;\n}> {\n  return cloudSaveProvider.restore();\n}\n\nexport async function getCloudBackupMetadata(): Promise<CloudSaveMetadata | null> {\n  return cloudSaveProvider.getBackupMetadata();\n}\n\nexport async function deleteCloudBackup(): Promise<boolean> {\n  return cloudSaveProvider.deleteBackup();\n}\n
